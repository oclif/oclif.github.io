"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[218],{9829:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>a});var o=n(4848),s=n(8453);const i={title:"Testing",description:"How to test your CLI"},r=void 0,c={id:"testing",title:"Testing",description:"How to test your CLI",source:"@site/../docs/testing.md",sourceDirName:".",slug:"/testing",permalink:"/docs/testing",draft:!1,unlisted:!1,editUrl:"https://github.com/oclif/oclif.github.io/tree/docs/docs/../docs/testing.md",tags:[],version:"current",lastUpdatedBy:"Mike Donnalley",lastUpdatedAt:1751457786e3,frontMatter:{title:"Testing",description:"How to test your CLI"},sidebar:"docs",previous:{title:"Single Command CLI",permalink:"/docs/single_command_cli"},next:{title:"Themes",permalink:"/docs/themes"}},d={},a=[{value:"Capturing <code>stdout</code> and <code>stderr</code> with Vitest",id:"capturing-stdout-and-stderr-with-vitest",level:2},{value:"Example <code>vitest.config.ts</code>",id:"example-vitestconfigts",level:3},{value:"Why This Matters",id:"why-this-matters",level:3},{value:"Code Coverage",id:"code-coverage",level:2}];function l(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(t.p,{children:["Testing in oclif can be done with any testing framework. You can run commands with ",(0,o.jsx)(t.code,{children:"MyCommand.run()"})," which returns a promise you can wait on."]}),"\n",(0,o.jsxs)(t.p,{children:["There are common tasks however when writing CLI tools. For this, we have ",(0,o.jsx)(t.a,{href:"https://github.com/oclif/test",children:"@oclif/test"}),", which provides a ",(0,o.jsx)(t.a,{href:"https://github.com/oclif/test?tab=readme-ov-file#usage",children:"conventional set of utilities"})," that we find useful for testing oclif CLIs."]}),"\n",(0,o.jsxs)(t.p,{children:["Any CLI built with oclif will come preloaded with ",(0,o.jsx)(t.a,{href:"https://www.npmjs.com/package/mocha",children:"mocha"})," (our preferred testing framework but you're free to use whatever you prefer) and ",(0,o.jsx)(t.a,{href:"https://github.com/oclif/test",children:"@oclif/test"})," as well as an example test that should work out of the box with ",(0,o.jsx)(t.code,{children:"npm test"})," or ",(0,o.jsx)(t.code,{children:"yarn test"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["As an example, let's look at this ",(0,o.jsx)(t.code,{children:"whoami"})," command which makes an API call to get the current logged in user. If the user is not logged in, it exits with status 100."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.strong,{children:"src/commands/whoami.ts"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-js",children:"import {Command} from '@oclif/core'\n\nexport class Whoami extends Command {\n  async run() {\n    try {\n      let {body: account} = await this.api.get('/account')\n      this.log(account.email)\n    } catch (err) {\n      if (err.statusCode === 401) {\n        this.error('not logged in', {exit: 100})\n      }\n      throw err\n    }\n  }\n}\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Another common tool we like to use in testing oclif CLIs is ",(0,o.jsx)(t.a,{href:"https://github.com/node-nock/nock",children:"nock"}),". Install the ",(0,o.jsx)(t.code,{children:"nock"})," package as a devDependency."]}),"\n",(0,o.jsx)(t.p,{children:"Here is the test code"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.strong,{children:"test/commands/whoami.test.ts"})}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-typescript",children:"import {runCommand} from '@oclif/test'\nimport {expect} from 'chai'\nimport nock from 'nock'\n\ndescribe('whoami', () => {\n  it('shows user email when logged in', async () => {\n    nock('https://api.example.com')\n      .get('/account')\n      // user is logged in, return their name\n      .reply(200, {email: 'jeff@example.com'})\n\n    const {stdout} = await runCommand('whoami')\n    expect(stdout).to.equal('jeff@example.com')\n  })\n\n  it('exits with status 100 when not logged in', async () => {\n    nock('https://api.example.com')\n      .get('/account')\n      // HTTP 401 means the user is not logged in with valid credentials\n      .reply(401)\n\n    const {error} = await runCommand('whoami')\n    expect(error?.oclif?.exit).to.equal(100)\n  })\n})\n"})}),"\n",(0,o.jsxs)(t.p,{children:["For more on how to test with oclif, check out the docs for ",(0,o.jsx)(t.a,{href:"https://github.com/oclif/test",children:"@oclif/test"}),"."]}),"\n",(0,o.jsxs)(t.h2,{id:"capturing-stdout-and-stderr-with-vitest",children:["Capturing ",(0,o.jsx)(t.code,{children:"stdout"})," and ",(0,o.jsx)(t.code,{children:"stderr"})," with Vitest"]}),"\n",(0,o.jsxs)(t.p,{children:["When using ",(0,o.jsx)(t.code,{children:"@oclif/test"})," in combination with ",(0,o.jsx)(t.strong,{children:"Vitest"}),", be aware that Vitest intercepts ",(0,o.jsx)(t.code,{children:"console.log"}),", ",(0,o.jsx)(t.code,{children:"console.error"}),", and other console methods by default. This can interfere with ",(0,o.jsx)(t.code,{children:"@oclif/test"}),"\u2019s ability to capture ",(0,o.jsx)(t.code,{children:"stdout"})," and ",(0,o.jsx)(t.code,{children:"stderr"})," when calling ",(0,o.jsx)(t.code,{children:"runCommand()"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["To ensure that ",(0,o.jsx)(t.code,{children:"stdout"})," and ",(0,o.jsx)(t.code,{children:"stderr"})," are captured properly (e.g. when using ",(0,o.jsx)(t.code,{children:'const { stdout, stderr } = await runCommand("config:dump");'}),"), you ",(0,o.jsx)(t.strong,{children:"must"})," disable console interception in your Vitest configuration by adding the line ",(0,o.jsx)(t.code,{children:"disableConsoleIntercept: true"})," to your ",(0,o.jsx)(t.code,{children:"vitest.config.ts"}),"."]}),"\n",(0,o.jsxs)(t.h3,{id:"example-vitestconfigts",children:["Example ",(0,o.jsx)(t.code,{children:"vitest.config.ts"})]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:'ts\nCopyEdit\nimport { defineConfig } from "vitest/config";\n\nexport default defineConfig({\n  test: {\n    setupFiles: ["./src/vitest.setup.ts"],\n    disableConsoleIntercept: true\n  }\n});\n\n'})}),"\n",(0,o.jsx)(t.h3,{id:"why-this-matters",children:"Why This Matters"}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.code,{children:"@oclif/test"})," relies on native ",(0,o.jsx)(t.code,{children:"stdout"}),"/",(0,o.jsx)(t.code,{children:"stderr"})," streams to verify command-line output. If ",(0,o.jsx)(t.code,{children:"Vitest"})," intercepts these streams, captured output will be incomplete or missing\u2014leading to failed or misleading assertions."]}),"\n",(0,o.jsx)(t.h2,{id:"code-coverage",children:"Code Coverage"}),"\n",(0,o.jsxs)(t.p,{children:["Code coverage is provided automatically for JavaScript and TypeScript projects via ",(0,o.jsx)(t.a,{href:"https://npm.im/nyc",children:"nyc"}),". Just run ",(0,o.jsx)(t.code,{children:"yarn test"})," and it will show the code coverage. The coverage can optionally be sent to ",(0,o.jsx)(t.a,{href:"https://codecov.io",children:"codecov"})," in the CI scripts as well."]})]})}function h(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>c});var o=n(6540);const s={},i=o.createContext(s);function r(e){const t=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),o.createElement(i.Provider,{value:t},e.children)}}}]);